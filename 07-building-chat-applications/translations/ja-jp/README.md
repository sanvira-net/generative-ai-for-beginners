# 生成 AI を利用したチャット・アプリケーションの構築

[![Building Generative AI-Powered Chat Applications](../..//images/07-lesson-banner.png?WT.mc_id=academic-105485-yoterada)](https://youtu.be/Kw4i-tlKMrQ?WT.mc_id=academic-105485-yoterada)

> *(上記の画像をクリックすると、レッスン・ビデオを表示します)*

テキスト生成アプリの構築方法を見てきたところで、次にチャット・アプリケーションについて考えてみましょう。

チャットアプリケーションは私たちの日常生活に溶け込み、単なるカジュアルな会話の手段以上のものを提供しています。それらはカスタマーサービスやテクニカルサポート、さらには高度なアドバイザリー・システムの重要な部分を担っています。あなたも最近、チャットアプリケーションから何らかの支援を受けたことがあるかもしれません。これらのプラットフォームに生成 AI などの先進技術を組み込むと、その複雑さは増し、それに伴い課題も増えてきます。

解答が必要な質問は以下の通りです。

- **アプリの構築** 特定のユースケースに対して、これらの AI を活用したアプリケーションを効率的に構築し、シームレスに統合するにはどうすればよいのでしょうか？
- **モニタリング** 一度デプロイした後、アプリケーションが機能面と[責任のあるAIの六つの原則](https://www.microsoft.com/ai/responsible-ai?WT.mc_id=academic-105485-yoterada)の遵守という観点から、最高レベルの品質で動作していることをどのように監視し、確認することができるのでしょうか？

自動化が進み、人間と機械が連続でやり取りする時代に突入する中で、生成 AI がチャット・アプリケーションの範囲、深さ、そして適応力をどう変えていくのかを理解することが重要です。このレッスンでは、これらの複雑なシステムを支えるアーキテクチャの側面を探求し、ドメイン固有のタスクに合わせてそれらを微調整する方法論を深掘りし、責任ある AI のデプロイを確実にするための指標と考慮点を取扱います。

## はじめに

このレッスンでは、下記の内容について説明します。

- チャット・アプリケーションを効率よく実装し、統合するためのテクニック
- アプリケーションにカスタマイズと微調整を適用する方法
- チャット・アプリケーションを効果的に監視するための戦略と考慮点

## 学習目標

このレッスンを修了すると、下記を理解できます：

- チャット・アプリケーションを実装し、既存のシステムに統合する際の考慮点を説明する
- 特定のユースケースに合わせてチャット・アプリケーションをカスタマイズする
- AI を活用したチャット・アプリケーションの品質を効果的に監視し、維持するために重要な指標と考慮点を特定する
- チャット・アプリケーションが責任ある AI の原則を活用することを確認する

## 生成　AI　をチャット・アプリケーションに統合する

生成 AI を用いてチャット・アプリケーションを進化させることは、ただ単にそれをスマートにするだけではありません。それは、アーキテクチャ、パフォーマンス、ユーザー・インターフェースを最適化し、ユーザーに高品質な体験を提供することもできます。これは、アーキテクチャの基盤、API 統合、ユーザー・インターフェースの考慮点を調査することも含みます。このセクションでは、既存のシステムに組み込むか、もしくは独立したプラットフォームとして構築するかに関わらず、これら複雑な領域を効率的に進めるための包括的なロードマップを提供します。

このセクションを終えると、あなたはチャットアプリケーションを効率的に実装し、統合するための専門知識を身につけることができます。

### チャットボットとチャットアプリケーション、どちらが適している？

チャット・アプリケーションの実装に取り組む前に、「チャット・ボット」と「AI 搭載チャット・アプリケーション」を比較し、それぞれが果たす役割と機能の違いを理解しましょう。チャット・ボットの主な目的は、よくある質問への回答や荷物の追跡など、特定の会話タスクを自動化することです。これは通常、ルール・ベースのロジックや複雑な AI アルゴリズムによって制御されます。それとは対照的に 「生成 AI を搭載したチャットアプリケーション」は、利用者との間でテキスト、音声、ビデオチャットなど、さまざまな形式のデジタル・コミュニケーションを可能にする、より広範囲な環境を提供します。その特徴は、微妙なニュアンスを持つ人間のような会話をシミュレートし、さまざまな入力と文脈上の手がかりに基づいて回答を生成する生成 AI モデルを統合した物です。生成 AI を搭載したチャット・アプリケーションは、特定のトピックや領域に限定せずあらゆる種類のトピックや質問に対応し、会話が進むにつれて変化するトピックや状況変化にも対応でき、さらには創造的な対話や複雑な対話を生み出すことができます。

下記の表は、デジタル・コミュニケーションにおけるそれぞれの役割を理解するのに役立つ、主な違いと類似点をまとめたものです。

| チャット・ボット                               | 生成 AI を搭載したチャットアプリケーション |
| ------------------------------------- | -------------------------------------- |
| タスク中心でルールベース          | 文脈(コンテキスト)を認識する                          |
| 大規模システムに統合されることが多い  | 1つまたは複数のチャット・ボットをホスト可能      |
| プログラムされた機能に限定       | 生成 AI モデルを搭載      |
| 専門的で構造化された対話を行う | オープン・ドメインでの議論が可能 (特定のトピックや領域に限定しない)     |

### SDK と API を活用した既存機能の利用

チャット・アプリケーションを開発する際、まずはすでに利用可能なライブラリを評価することが重要です。SDK と API を使ってチャット・アプリケーションを構築することは、様々な理由から有効な戦略となります。十分に文書化された SDK と API を利用することで、アプリケーションを長期的な成功に向けて戦略的に位置付けられ、スケーラビリティやメンテナンスの問題に対応します。

- **開発プロセスの迅速化とオーバーヘッドの削減**: 高コストな自作機能の構築（車輪の再発明）ではなく、既存のライブラリを利用することで、ビジネスロジックなど、より重要と考えられるアプリケーションの開発に集中できます。
- **パフォーマンスの向上**: 機能を一から構築すると、いずれ「どのようにスケールするのか？このアプリケーションは突然のユーザー増加に対応できるのか？」と自問することになります。適切にメンテナンスされた SDK と API は、これらの問題に対する解決策を含んでいます。
- **メンテナンスの容易さ**: ほとんどの API と SDK で、新しいバージョンがリリースされた際にライブラリを更新するだけで済むため、アップデートや改善の管理が容易になります。
- **最先端技術へのアクセス**: 大規模なデータセットで微調整やトレーニングが行われたモデルを活用することで、アプリケーションに自然言語処理の能力を付与します。

SDK や API の機能を利用するためには、通常、提供されるサービスの使用許可を取得する必要があります。これは、一意のキーや認証トークンを使って行われます。OpenAI Python ライブラリを使って、これがどのように行われるのか確認してみましょう。また、このレッスン用の [OpenAI のノートブック](../../notebook-openai.ipynb?WT.mc_id=academic-105485-yoterada)や [Azure OpenAI Services のノートブック](../../notebook-azure-openai.ipynb?WT.mc_id=academic-105485-koreys)を使って、自分で試すこともできます。

```python
import os
import openai

openai.api_key = os.getenv("OPENAI_API_KEY")

chat_completion = openai.ChatCompletion.create(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "生成 AI のチャット・アプリケーションに関するトレーニング・タイトルを2つ提案してください。"}])
```

上記の例では、GPT-3.5 Turbo モデルを使用してプロンプトを完了しますが、その前に API キーを設定している点にご注意ください。キーを設定しなかった場合は、次のエラーが表示されます。

```output
AuthenticationError: No API key provided. 
You can set your API key in code using 'openai.api_key = <API-KEY>', 
or you can set the environment variable OPENAI_API_KEY=<API-KEY>). 
If your API key is stored in a file, you can point the openai module 
at it with 'openai.api_key_path = <PATH>'. 
You can generate API keys in the OpenAI web interface. 
See https://platform.openai.com/account/api-keys for details.
```

## ユーザーエクスペリエンス (UX)

一般的な UX の原則はチャット・アプリケーションにも適用されますが、機械学習の要素が関わるため、特に重要な追加の考慮点がいくつかあります。

- **曖昧さへの対処方法**: 生成 AI モデルは時折、曖昧な回答を生成します。ユーザーがこの問題に遭遇した際に、明確化を求めることができる機能は役立ちます。
- **文脈（コンテキスト）の保持**: 高度な生成 AI モデルは、会話の文脈(会話履歴)を記憶する能力を持っており、これはユーザー・エクスペリエンスにとって必要な要素になります。ユーザーに文脈を制御し管理する能力を与えることで、ユーザー・エクスペリエンスは向上しますが、それと同時に、機密性の高いユーザー情報を保持するリスクも生じます。この情報をどの位の期間保持するか、例えば保持期間のポリシーを導入するなどの考慮が必要で、これにより文脈の必要性とプライバシーのバランスを保つことができます。
- **パーソナライゼーション**: 学習と適応の能力を持つ AI モデルは、ユーザーに個別のエクスペリエンスを提供します。ユーザー・プロファイルなどの機能を通じてユーザー・エクスペリエンスをカスタマイズすることは、ユーザーが理解されていると感じさせるだけでなく、特定の回答を見つけるための手助けを行い、より効率的で満足度の対話を生み出します。

パーソナライゼーションの一例として、OpenAI の ChatGPT では「Custom instructions（カスタム指示）」設定があります。これは、プロンプトに重要なコンテキストとなる自身の情報を提供することができるようになります。下記にカスタム指示の例を示します。

![Custom Instructions Settings in ChatGPT](../../images/custom-instructions.png?WT.mc_id=academic-105485-yoterada)

この「プロファイル」は、ChatGPT に Linked Lists のレッスン・プランを作成するように促します。ChatGPT は、ユーザーが自分の経験に基づいて、より詳細なレッスン・プランが必要かもしれないことを、ちゃんと考慮している点にご注意ください。

![A prompt in ChatGPT for a lesson plan about linked lists](../../images/lesson-plan-prompt.png?WT.mc_id=academic-105485-yoterada)

### 大規模言語モデル用の Microsoft のシステム・メッセージ・フレームワーク

Microsoftは、大規模言語モデル（LLM）からの回答を生成する際に、効果的なシステムメッセージを作成するための[ガイダンス](https://learn.microsoft.com/azure/ai-services/openai/concepts/system-message#define-the-models-output-format?WT.mc_id=academic-105485-yoterada)を提供しています。これは以下の4つの領域に分類できます：

1. モデルの対象者、能力、そして制限を明確にします
2. モデルの出力形式を定義します
3. モデルの意図した動作を示す、具体的な例を提供します
4. 追加の行動規範を提供します

### アクセシビリティについて

視覚、聴覚、運動機能、認知機能に関してご不自由な方も、適切に設計されたチャット・アプリケーションは利用できるべきです。下記に、各利用者に対応するためにアクセシビリティを強化する機能をリストアップします。

- 視覚にご不自由がある方向けの機能：ハイ・コントラストのテーマや、文字サイズの変更が可能なテキスト、スクリーンリーダーとの互換性
- 聴覚にご不自由がある方向けの機能：テキストから音声へ、音声からテキストへの変換機能、音声通知の視覚的な手助け
- 運動機能にご不自由がある方向けの機能：キーボードによるナビゲーションのサポート、音声コマンド
- 認知機能にご不自由がある方向けの機能：簡易化された言語オプション

## ドメイン固有言語モデルのカスタマイズと微調整

会社の専門用語を理解し、お客様が一般的に抱く特定の質問に答えるチャット・アプリケーションを想像してみてください。そのためのアプローチとして、以下の二つが挙げられます。

- **DSL モデルの活用**：DSL はドメイン固有言語を意味します。特定の領域で訓練された DSL モデルを活用することで、その領域の概念やシナリオを理解することができます。
- **ファインチューニングの適用**：ファイン・チューニングとは、特定のデータを用いてモデルをさらに訓練するプロセスのことです。

## カスタマイズ ： DSLの使用

ドメイン固有言語モデル（DSLモデル）を活用することで、ユーザー・エンゲージメントを強化し、専門的で文脈に適した対話を提供することができます。これは、特定の分野、業界、または主題に関連するテキストを理解し、生成するために訓練またはファイン・チューニングされたモデルです。DSLモデルの使用方法は、ゼロから訓練することから、SDK や API を通じて既存のものを使用することまで様々です。また、既存の事前に訓練済みモデルを取得し、それを特定の領域に適応させるためのファイン・チューニングも選択肢の一つです。

## カスタマイズ：ファイン・チューニングの適用

ファイン・チューニングは、事前訓練済みのモデルが特殊な領域や特定のタスクに対応できない場合に検討します。

例えば、医療に関する問い合わせは複雑で、多くの文脈が必要です。医療専門家が患者を診断する際には、ライフスタイルや過去の病歴など様々な要素に基づき、さらに診断を裏付けるために最新の医学論文に頼ることもあります。このような微妙なシナリオでは、汎用的な AI チャット・アプリケーションでは信頼性に欠けます。

### シナリオ: 医療アプリケーション

治療ガイドライン、薬物服用の影響、最新の研究結果などを素早く参照できるように、医療従事者を支援するチャット・アプリケーションを考えてみましょう。

通常のモデルは、基本的な医学の問い合わせに答えたり、一般的なアドバイスを提供するのに十分かもしれませんが、以下のような状況では対応が難しいかもしれません。

- **非常に特殊または複雑なケース** 例えば、神経内科医がアプリケーションに「小児の薬剤耐性てんかんの管理における現在のベストプラクティスは何ですか？」と尋ねる場合などです。
- **最新の情報が反映されていない** 一般的なモデルは、神経学や薬理学の最新の進歩を取り入れた現在の答えを提供するのが難しいかもしれません。

このような場合、専門的な医療データセットを用いてモデルをファイン・チューニングすることで、これらの複雑な医療に関する問い合わせを、より正確かつ信頼性高く処理する能力を大幅に向上させることができます。これには、対応が必要なドメイン固有の課題と質問を反映した、大規模で関連性の高いデータセットへのアクセスが必要です。

## 高品質な AI 駆動のチャット体験に必要な考慮事項

このセクションでは、「高品質」なチャット・アプリケーションの基準を説明します。これには、実用的な指標(メトリクス)の取得方法や、責任ある AI の原則を取り入れたフレームワークの利用も含まれます。

### 重要な指標（メトリクス）

アプリケーションを高品質でパフォーマンスを維持するためには、重要な指標（メトリクス）と考慮事項を把握し続けることが必要です。これらの測定は、アプリケーションの機能性を保証するだけでなく、AI モデルとユーザー・エクスペリエンスの品質を評価するためにも必要です。下記に、基本的なメトリクス、AI に関するメトリクス、ユーザー・エクスペリエンスに関するメトリクスを考慮するためのリストを示します。

| メトリック                        | 定義                                                                                                             | チャット開発者の検討事項                                         |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| **アップタイム**                    | アプリケーションが稼働し、ユーザーが利用可能な時間を計測します                                              | ダウンタイムをどのように最小限に抑えますか?                                           |
| **応答時間**             | アプリケーションがユーザーからの問い合わせに応答するまでの時間                                                          | クエリ処理をどのように最適化し、応答時間を改善しますか?           |
| **精度**                 | 真陽性予測の割合を、陽性予測の総数で割ったもの　</br></br>（訳者による追記：モデルで提供される正しい出力の数 (真陽性) と、陽性サンプルの総数 (真陽性+偽陽性) を比較 [1](https://plat.ai/blog/confusion-matrix-in-machine-learning/)）                                     | モデルの精度をどのように確認しますか?                        |
| **再現率 (Sensitivity)**      | 真陽性予測の数を実際の真の数で割った比率  </br></br>（訳者による追記：真の値の総数に対する、正しく分類された陽性サンプル(TP)の数の比率として計算 [1](https://plat.ai/blog/confusion-matrix-in-machine-learning/)）                                          |　Recall をどのように測定し、改善しますか?                                  |
| **F1 スコア**                  | 精度と再現率の調和平均で、両者のバランスを示します                                   | 目指すF1スコアは何ですか?精度と再現率のバランスをどのように調整しますか?  |
| **Perplexity**                | モデルが予測した確率分布が、データの実際の分布とどれだけ一致しているかを計測します。</br></br>(訳者追記：Perplexityは、言語モデルが与えられた文書をどの程度正確に予測できるかを示す指標で、値が小さいほど性能が良い) | Perplexity をどのように最小限に抑えますか?                                         |
| **ユーザー満足度指標** | アプリケーションに対するユーザーの評価を計測します。主にアンケートを通じて収集します                                     | ユーザーフィードバックはどのくらいの頻度で収集しますか?それに基づいてどのように改善策を立てますか? |
| **エラー発生率**                | モデルが理解や出力で間違いを犯す割合                                                 | エラー発生率を減らすための戦略は何ですか?               |
| **再トレーニングサイクル**         | 新しいデータや知見を取り入れてモデルを更新する頻度                                    | どのくらいの頻度でモデルを再トレーニングしますか?再トレーニングサイクルを開始するトリガーは何ですか?   |
| **異常検出**         | 期待する動作に適合しない異常なパターンを識別するためのツールと手法                        | 異常が発生した際にどのように対応しますか?                                        |

### チャット・アプリケーションにおける責任ある AI の実践導入

Microsoft の責任ある AI に対する取り組みは、AI の開発と利用を推奨する 6 つの原則を明らかにしています。下記に、それらの原則とその定義、そしてチャット開発者が考慮すべき事項と、それらをなぜ真剣に考えるべきかを説明します。

| 原則             | Microsoftの定義                                | チャット開発者に関する考慮事項                                      | 重要な理由                                                                     |
| ---------------------- | ----------------------------------------------------- | ---------------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| 公平性               | AI システムは全ての人を公平に扱うべきです            | ユーザーデータに基づく差別がないようにチャットアプリケーションを設計します  | ユーザー間で信頼と包括性を築き、法的な問題を避けるためです                |
| 信頼性と安全性 |AI システムは確実かつ安全に動作するべきです        | エラーやリスクを最小限に抑えるためにテストとフェイルセーフを実装します         | ユーザーの満足度を確保し、潜在的な危険を防ぐためです                                 |
| プライバシーとセキュリティ   | AI システムは安全であり、プライバシーを尊重するべきです      | ユーザーデータを保護するために強力な暗号化とデータ保護対策を実装します              | ユーザーの機密データを保護し、プライバシー法を遵守するためです                         |
| 包括性          | AI システムは全ての人を活力づけ、人々を巻き込むべきです | 多様なユーザーがアクセスしやすく使いやすい UI/UX を設計します | 多くの人がアプリケーションを効果的に使用できるようにするためです                   |
| 透明性           | AI システムは理解しやすく実装するべきです                 | AI の応答について明確なドキュメンテーションと理由を提供します           | ユーザーは、意思決定がどのように行われるかを理解できれば、システムを信頼する可能性が高まります |
| 説明責任         | 人々は AI システムに対して説明責任を負うべきです          | AI の意思決定を監査し、改善するための明確なプロセスを設立します     | 継続的な改善とミスが発生した場合の是正措置を可能にするためです           |

## 課題

[課題](../../notebook-azure-openai.ipynb?WT.mc_id=academic-105485-yoterada)をご覧ください。最初のチャット・プロンプトの実行から、テキストの分類や要約など、一連の演習を行うことができます。

## お疲れ様でした!　学習を続ける

このレッスン修了後、[生成 AI 学習コレクション](https://aka.ms/genai-collection?WT.mc_id=academic-105485-yoterada) をチェックして、Generative AI の知識をレベルアップさせましょう。

レッスン 8 では、[検索アプリケーションの構築](../../../08-building-search-applications/translations/ja-jp/README.md?WT.mc_id=academic-105485-yoterada)方法を見ていきます。
